function getImages(){var e=database.ref("/images");e.orderByChild("time").limitToFirst(7).once("value",function(e){for(;home.hasChildNodes();)home.removeChild(home.lastChild);e.numChildren()<7&&$("#loadMore").addClass("hidden");var t=0;e.forEach(function(e){return 6==t?void(nextTime=e.val().time):(createImgTag(e.val().imageName,e.val().storageLink,home,!1),void t++)}),$("#loadMore").removeClass("hidden")})}function createImgTag(e,t,a,i){for(var n=0;n<a.childNodes.length;n++){var o=a.childNodes[n].getElementsByTagName("img");if(o[0].getAttribute("data-imgData")==e)return}var d=document.createElement("img"),t=storage.ref(t+mobile);t.getDownloadURL().then(function(t){d.src=t,d.setAttribute("data-toggle","modal"),d.setAttribute("data-target","#imageModal"),d.setAttribute("data-imgData",e),d.setAttribute("alt",e);var n=document.createElement("div");n.className="homepage-image",n.appendChild(d),i?a.insertBefore(n,a.firstChild):a.appendChild(n)})}function getRadioVal(e){for(var t="",a=document.getElementsByName(e),i=0;i<a.length;i++)a[i].checked&&(t=a[i].value);return t}function genTemplate(e){var t="";for(var a in e)if("imageName"!=a){var i=e[a];i?"time"==a&&(i=readableDate(String(i))):i="No "+a+"!";var n=a.charAt(0).toUpperCase()+a.slice(1);t+="<h3>"+n+"</h3><br/>",t+="<p>"+i+"</p><br/><br/>"}return t}function addHiddenEdit(){var e='<div id="editView" class="hidden"><h2 style="text-align: center">Edit Art</h2><p>Title:</p><input type="text" id="editTitle"><br/><br/><p>Location:</p><input type="text" id="editLocation"><br/><br/><p>Safe for work:<div id="sfwRadios"></p><input type="radio" name="editSFW" value="Yes">Yes<input type="radio" name="SFW" value="No">No</div><br/><br/><p>Description:</p><input type="text" id="editDescription"><br/><br/><p>Tags:</p><input type="text" id="editTags"><br/><br/><p>File:</p><input type="file" id="editFile"><br/><br/></div>';return e}function mobileScale(e){var t=new Image,a=new FileReader,i=e.name.split(".")[0];a.onload=function(e){t.src=a.result;var n=resizeInCanvas(t);n.toBlob(function(e){storage.ref().child(i+"_m").put(e)},"image/jpeg")},t.src=a.readAsDataURL(e)}function resizeInCanvas(e){var t=document.createElement("canvas"),a=300,i=300,n=e.width,o=e.height;n>o?n>a&&(o*=a/n,n=a):o>i&&(n*=i/o,o=i),t.width=n,t.height=o;var d=t.getContext("2d");return d.drawImage(e,0,0,n,o),t}function buildTime(){var e=new Date,t=e.getMonth()+1,a=e.getDate(),i=e.getHours(),n=e.getMinutes(),o=e.getSeconds();return 10>t&&(t="0"+t),e.getDate()<10&&(a="0"+e.getDate()),e.getHours()<10&&(i="0"+e.getHours()),e.getMinutes()<10&&(n="0"+e.getMinutes()),e.getSeconds()<10&&(o="0"+e.getSeconds()),e.getFullYear()+""+t+a+i+n+o}function readableDate(e){var t=e.substring(0,4),a=e.substring(4,6),i=e.substring(6,8),n=e.substring(8,10),o=e.substring(10,12);return n>12?(n-=12,o+="pm"):o+="am",a+"/"+i+"/"+t+", "+n+":"+o}var config={apiKey:"AIzaSyDKis9ipJ3fiPgjAe3DeoXkB1waqDg2knU",authDomain:"cse-134b-hw4.firebaseapp.com",databaseURL:"https://cse-134b-hw4.firebaseio.com",storageBucket:"cse-134b-hw4.appspot.com",messagingSenderId:"47888727463"};firebase.initializeApp(config);var storage=firebase.storage(),database=firebase.database(),mobile="",disableScroll=!1,home=document.getElementById("homepage-container"),nextTime=0,snackbar=document.getElementById("snackbar"),user=firebase.auth().currentUser,logout=document.getElementById("logout"),userShow=document.getElementById("user");firebase.auth().onAuthStateChanged(function(e){user=e,e?(logout.classList.remove("hidden"),userShow.classList.remove("hidden"),userShow.innerHTML=user.email):(logout.classList.add("hidden"),userShow.classList.add("hidden"))}),logout.onclick=function(){firebase.auth().signOut()},window.onload=function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(mobile="_m"),getImages();var e=database.ref("/images");e.on("child_added",function(e){$("#loadMore").is(":disabled")&&$("#loadMore").prop("disabled",!1)})},$("#loadMore").click(function(){var e=database.ref("/images");e.orderByChild("time").limitToFirst(7).startAt(nextTime).once("value").then(function(e){var t=0;e.numChildren()<7&&$("#loadMore").prop("disabled",!0),e.forEach(function(e){return 6==t?void(nextTime=e.val().time):(createImgTag(e.val().imageName,e.val().storageLink,home,!1),void t++)})})});var loginSubmit=document.getElementById("loginSubmit");loginSubmit.onclick=function(){var e=document.getElementById("loginEmail").value,t=document.getElementById("loginPassword").value;firebase.auth().signInWithEmailAndPassword(e,t)["catch"](function(e){var t=(e.code,e.message);window.alert(t)}).then(function(){$("#loginModal").modal("hide"),snackbar.className="show",snackbar.innerHTML="Logged in! Welcome back "+user.email,setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},3e3)})};var registerSubmit=document.getElementById("registerSubmit");registerSubmit.onclick=function(){var e=document.getElementById("registerEmail").value,t=document.getElementById("registerPassword").value;firebase.auth().createUserWithEmailAndPassword(e,t)["catch"](function(e){var t=(e.code,e.message);window.alert(t)}).then(function(){$("#registerModal").modal("hide"),snackbar.className="show",snackbar.innerHTML="Registered! Now you can log in!",setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},3e3)})};var provider=new firebase.auth.GoogleAuthProvider,googleLogin=document.getElementById("googleLogin");googleLogin.onclick=function(){firebase.auth().signInWithPopup(provider).then(function(e){e.credential.accessToken;user=e.user})["catch"](function(e){e.code,e.message,e.email,e.credential}).then(function(){$("#loginModal").modal("hide"),snackbar.className="show",snackbar.innerHTML="Logged in! Welcome back "+user.email,setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},3e3)})},$("#imageModal").on("show.bs.modal",function(e){var t,a=$(e.relatedTarget),i=document.createElement("img"),n=a[0].dataset.imgdata,o=this,d=o.getElementsByClassName("modal-body")[0];d.textContent="Content Loading...";var s=document.createElement("div");s.id="imgDetails",database.ref("/images").child(n).once("value").then(function(e){t=e.val();var a=document.createElement("div");if(a.id="imgDetails",!t)return void(d.innerHTML="Image not found!");var n=document.getElementById("imageModalTitle");t.imageName&&(n.textContent=t.imageName);var a=document.createElement("div");a.id="imgDetails",a.insertAdjacentHTML("beforeend",genTemplate(t)),storage.ref(t.storageLink+mobile).getDownloadURL().then(function(e){d.textContent="",i.src=e;var t=document.createElement("div");t.id="infoBody",t.appendChild(a),t.appendChild(i),d.appendChild(t),d.insertAdjacentHTML("beforeend",addHiddenEdit())})});var r=document.getElementById("deleteImgBtn");r.onclick=function(){if(!user)return void alert("You must log in to use this function.");if(t){if(!confirm("Are you sure you want to delete "+imageInfo.imageName+"?"))return;var e=t.storageLink;database.ref("/images").child(n).remove(),storage.ref(e)["delete"]();for(var a=0;a<home.childNodes.length;a++){var i=home.childNodes[a].getElementsByTagName("img");i[0].getAttribute("data-imgData")==t.imageName&&home.removeChild(home.childNodes[a])}}$("#imageModal").modal("hide"),snackbar.className="show",snackbar.innerHTML=t.imageName+" is gone forever!",setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},3e3)};var l=document.getElementById("editImgBtn"),m=document.getElementById("confirmEditsBtn"),c=document.getElementById("cancelEditsBtn");l.onclick=function(){if(!user)return void alert("You must log in to use this function.");if($("#editView").hasClass("hidden")){var e=document.getElementById("editView");e.classList.remove("hidden"),m.classList.remove("hidden"),c.classList.remove("hidden"),$("#editImgBtn").addClass("hidden"),$("#deleteImgBtn").addClass("hidden")}},c.onclick=function(){for(var e=document.getElementById("editView"),t=e.getElementsByTagName("input"),a=0;a<t.length;a++)"radio"!=t[a].type?t[a].value="":t[a].checked=!1;e.classList.add("hidden"),m.classList.add("hidden"),c.classList.add("hidden"),$("#editImgBtn").removeClass("hidden"),$("#deleteImgBtn").removeClass("hidden")},m.onclick=function(){var e=document.getElementById("editTitle").value,a=document.getElementById("editLocation").value,i=getRadioVal("editSFW"),n=document.getElementById("editDescription").value,o=document.getElementById("editTags").value,d=document.getElementById("editFile").files[0];e?database.ref("images").child(t.imageName).remove():e=t.imageName,a||(a=t.location),i||(i=t.safety),n||(n=t.description),o||(o=t.tags);document.getElementById("editView");if(d)storage.ref(t.storageLink)["delete"](),storage.ref().child(d.name).put(d).then(function(t){storageLinkName=t.a.fullPath;var d=firebase.database().ref("/images");d=d.child(e).update({imageName:e,location:a,safety:i,description:n,tags:o,storageLink:storageLinkName}).then(function(){$("#cancelEditsBtn").click(),$("#imageModal").modal("hide")})});else{var s=database.ref("/images");s.child(e).update({imageName:e,location:a,safety:i,description:n,tags:o,storageLink:t.storageLink}).then(function(){$("#cancelEditsBtn").click(),$("#imageModal").modal("hide")})}snackbar.className="show",snackbar.innerHTML="Changes to "+e+" have been saved!",setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},3e3)}}),$("#imageModal").on("hide.bs.modal",function(){document.getElementById("imageModalTitle").textContent="";for(var e=this.getElementsByClassName("modal-body")[0];e.hasChildNodes();)e.removeChild(e.lastChild);var t=document.getElementById("confirmEditsBtn");t.classList.add("hidden"),$("#cancelEditsBtn").addClass("hidden"),$("#editImgBtn").removeClass("hidden"),$("#deleteImgBtn").removeClass("hidden")}),$("#loginModal").on("hide.bs.modal",function(){for(var e=this.getElementsByTagName("input"),t=0;t<e.length;t++)e[t].value=""}),$("#registerModal").on("hide.bs.modal",function(){for(var e=this.getElementsByTagName("input"),t=0;t<e.length;t++)e[t].value=""}),$("#addArtModal").on("hide.bs.modal",function(){for(var e=this.getElementsByTagName("input"),t=0;t<e.length;t++)"radio"!=e[t].type?e[t].value="":e[t].checked=!1});var changesBtn=document.getElementById("saveChanges");changesBtn.onclick=function(){if(!user)return alert("You must log in to use this function.."),void $("#addArtModal").modal("hide");var e=document.getElementById("title").value,t=document.getElementById("location").value,a=getRadioVal("SFW"),i=document.getElementById("description").value,n=document.getElementById("tags").value,o=document.getElementById("file").files[0],d="",s="";if(e||(s+="Please include a title. \n"),t||(s+="Please include a location. \n"),a||(s+="Please indicate a safety rating. \n"),i||(s+="Please include a description."),o||(s+="Please attach an image"),s)return void window.alert(s);if(o){mobileScale(o);var r=o.name.split(".")[0],l=storage.ref().child(r);l.put(o).then(function(o){d=o.a.fullPath;var s=firebase.database().ref("/images");s=s.child(e).set({imageName:e,location:t,safety:a,description:i,tags:n,time:buildTime(),storageLink:d.split(".")[0]})}).then(function(){$("#addArtModal").modal("hide");var t=d.split(".")[0];createImgTag(e,t,home,!0),home.childNodes.length<=1&&$("#loadMore").prop("disabled",!0),snackbar.className="show",snackbar.innerHTML=e+" has been added. Good work!",setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},3e3)})}};